<head>
    <meta id="meta" name="viewport" content="width=device-width; initial-scale=1.0" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <link rel="shortcut icon" href="static/favicon/favicon.png"/>
    <title>JPM Pokémon Map</title>
</head>
<style>
    html { height: 100% }
    body { height: 100%; margin: 0px; padding: 0px }
    #map_wrapper {
        height: 100%;
    }
    #map_canvas {
        width: 100%;
        height: 100%;
    }
    #loader{
        display:none;
        bottom:5px;
        left:50%;
        transform: translateX(-50%);
        bottom:15px;
    }
    #loader.show{
        display:block;
        font-weight:bold;
    }
    #loader.green{
        background-color:#0F0;
    }
    #loader.red {
        background-color:#F00;
        color:white;
    }
    #control_panel, #loader{
        z-index: 999;
        position:fixed;
        font-family: SANS-SERIF;
        background-color: #fff;
        border-radius:10px;
        padding: 20px;
        opacity: .6;
    }
    #control_panel{
        width:150px;
        left:15px;
        bottom:15px;
    }
    #control_panel.mylocation .auto-search{
        display:block;
    }
    #control_panel.mapcenter .manual-search{
        display:block;
    }
</style>

<div id="loader">
    Please wait... searching for pokemon.
</div>
<div id="control_panel">
    <div class="manual-search">
        <button id="update">Refresh</button>
        <button id="manual_search">Search</button>
        <br>
        <br>
    </div>
    <strong>Search by:</strong><br/>
    <input type="radio" name="searchType" value="mylocation" checked/> My Location<br/>
    <input type="radio" name="searchType" value="mapcenter"/> Map Center<br/>
</div>
<div id="map_wrapper">
    <div id="map_canvas" class="mapping">Detecting location...</div>
</div>
<script>
    var player = null;
    var lastPosition = null;
    var lastMessage = null;
    var userLogged = false;
    var map;
    var pokes = {};
    var stops = {};
    var mode = null;
    var pad = function (number) { return number <= 99 ? ("0" + number).slice(-2) : number; }

    jQuery(function($) {
        var script = document.createElement('script');
        script.src = '//maps.googleapis.com/maps/api/js?key={{GMAPS_API_KEY}}&sensor=false&callback=initMap';
        document.body.appendChild(script);
        $("[name='searchType']").on('change', function(){
            update_mode();
        });
        $("#manual_search").on('click', function(){
            getNewData();
        });
        $("#update").on('click', function(){
            getPokemons();
            getPokestops();
        });
        
        update_mode();
    });

    function update_mode(){
        mode = $("[name='searchType']:checked").val();
        $("#control_panel").removeClass("mylocation").removeClass("mapcenter").addClass(mode);
    }

    var updateLabelDiffTime = function() {
        $('.label-countdown').each(function(index, element) {
            var disappearsAt = new Date(parseInt(element.getAttribute("disappears-at")));
            var now = new Date();

            var difference = Math.abs(disappearsAt - now);
            var hours = Math.floor(difference / 36e5);
            var minutes = Math.floor((difference - (hours * 36e5)) / 6e4);
            var seconds = Math.floor((difference - (hours * 36e5) - (minutes * 6e4)) / 1e3);

            if (disappearsAt < now) {
                timestring = "(expired)";
            } else {
                timestring = "(";
                if (hours > 0)
                    timestring = hours + "h";

                timestring += ("0" + minutes).slice(-2) + "m";
                timestring += ("0" + seconds).slice(-2) + "s";
                timestring += ")";
            }

            $(element).text(timestring)
        });
    };

    window.setInterval(updateLabelDiffTime, 1000);  

    function addMinutes(date, minutes) {
       return new Date(date.getTime() + minutes*60000);
    }

    function add_pokemon(data) {
        data.uid = data.key;
        data.ico = '/static/poke/' + data.id + '.png';
        data.position = new google.maps.LatLng(data.latitude, data.longitude);
        
        var marker = add_marker(data);

        marker.infoWindow = new google.maps.InfoWindow({
            content: pokemonLabel(data.name, data.hides_at, data.distance)
        });

        var listener = marker.addListener('click', function() {
            marker.infoWindow.open(map, marker);
            updateLabelDiffTime();
        });
        
        var timeLeft = parseInt(data.time_left);
        var pokemon = {marker:marker, listener:listener, data:data};
        
        setTimeout(function(){
            clear_pokemon(pokemon);	
        }, timeLeft);
        pokes[data.uid] = pokemon;        
    }

    function pokemonLabel(name, disappear_time, distance) {
        var disappear_date = new Date(disappear_time);

        var contentstring = `
            <div>
                <b>${name}</b>
            </div>
            <div>
                Disappears at ${pad(disappear_date.getHours())}:${pad(disappear_date.getMinutes())}:${pad(disappear_date.getSeconds())}
                <span class='label-countdown' disappears-at='${disappear_time}'>(00m00s)</span>
            </div>
            <div>
                Is at ${distance} m from you
            </div>`;

        return contentstring;
    }

    function clear_pokemon(pokemon){
        google.maps.event.removeListener(pokemon.listener);
        pokemon.marker.setMap(null);
        delete pokes[pokemon.data.uid];
    }

    function add_pokestop(data) {
        data.uid = data.key;
        data.ico = '/static/fort/PstopLured.png';
        data.position = new google.maps.LatLng(data.latitude, data.longitude);

        var marker = add_marker(data);

        marker.infoWindow = new google.maps.InfoWindow({
            content: pokestopLabel(data.last_modified, data.pokemon_name)
        });

        var listener = marker.addListener('click', function() {
            marker.infoWindow.open(map, marker);
            updateLabelDiffTime();
        });

        var time_until_expire = addMinutes(new Date(data.last_modified), 30).getTime() - new Date().getTime();

        var stop = {marker:marker, listener:listener, data:data};
        setTimeout(function(){
            clear_pokestop(stop);	
        }, time_until_expire);
        stops[data.uid] = stop;
    }

    function pokestopLabel(last_modified, pokemon, latitude, longitude) {

        var last_modified_date = new Date(last_modified);
        var current_date = new Date();
        
        var time_until_expire = addMinutes(last_modified_date, 30).getTime() - current_date.getTime();

        var expire_date = new Date(current_date.getTime() + time_until_expire);
        var expire_time = expire_date.getTime();

        str = `
            <div>
                <b>Lured Pokéstop</b>
            </div>
            <div>
                Lured Pokémon: <b>${pokemon}</b>
            </div>
            <div>
                Lure expires at ${pad(expire_date.getHours())}:${pad(expire_date.getMinutes())}:${pad(expire_date.getSeconds())}
                <span class='label-countdown' disappears-at='${expire_time}'>(00m00s)</span></div>
            <div>`;

        return str;
    }

    function clear_pokestop(pokestop){
        google.maps.event.removeListener(pokestop.listener);
        pokestop.marker.setMap(null);
        delete stops[pokestop.data.uid];
    }

    function clear_markers() {
        var keys = Object.keys(pokes);
        for (var i = 0; i < keys.length; i++) {
            clear_pokemon(pokes[keys[i]]);
        }
        pokes = {};
        keys = Object.keys(stops);
        for (var i = 0; i < keys.length; i++) {
            clear_pokestop(stops[keys[i]]);
        }
        stops = {};
    }

    function requestLogin(location) {
        clear_markers();
        var loc = location.coords.latitude.toString()+', '+location.coords.longitude.toString();
        $.ajax({ 
            type: 'POST', 
            url: '/login', 
            data: {
                location: loc
            }, 
            dataType: 'json',
            success: function (data) {
                userLogged = true;
                setTimeout(function(){
                    getPokemons();
                    getPokestops();
                }, 10000);
            },
            error: function(e) {
                error('Error while attempting to login');
                setTimeout(function(){
                    hide_message();
                }, 3000);
                console.log('Error while attempting to login');
            }
        });
    }

    function getPokemons() {
        $.ajax({ 
            type: 'POST', 
            url: '/getPokes', 
            dataType: 'json',
            success: function (data) {
                var count = data ? data.data.length : 0;
                $.each(data.data, function(k, v) {
                    if(!(v.key in pokes)) {
                        add_pokemon(v);
                    }
                });
                if (count > 0) {
                    info("Added " + count + " pokémon!");
                }
                getMoreData();
            },
            error: function(e) {
                error('Error while fetching Pokémon');
                setTimeout(function(){
                    hide_message();
                }, 3000);
                console.log(e);
                setTimeout(function(){
                    getPokemons();
                }, 5000);
            }
        });
    }

    function getPokestops() {
        $.ajax({ 
            type: 'POST', 
            url: '/getStops', 
            dataType: 'json',
            success: function (data) {
                $.each(data.data, function(k, v) {
                    if(!(v.key in stops)) {
                        add_pokestop(v);
                    } else {
                        var pokestop = stops[v.key].data;
                        if(pokestop.pokemon_name != v.pokemon_name) {
                            clear_pokestop(stops[v.key]);
                            add_pokestop(v);
                        }
                    }
                });
            },
            error: function(e) {
                error('Error while fetching Pokestops');
                setTimeout(function(){
                    hide_message();
                }, 3000);
                console.log(e);
                setTimeout(function(){
                    getPokestops();
                }, 5000);
            }
        });
    }

    function getMoreData() {
        $.ajax({ 
            type: 'POST', 
            url: '/moreData', 
            dataType: 'json',
            success: function (data) {
                if(data.data == true) {
                    setTimeout(function(){
                        getPokemons();
                        getPokestops();
                    }, 3000);
                } else {
                    success("Found " + Object.keys(pokes).length + " pokémon!");
                    setTimeout(function(){
                        hide_message();
                    }, 5000);
                }
            },
            error: function(e) {
                error('Error while getting more data');
                setTimeout(function(){
                    hide_message();
                }, 3000);
                console.log(e);
                setTimeout(function(){
                    getMoreData();
                }, 5000);
            }
        });
    }

    function getNewData() {
        var loc = lastPosition.coords.latitude.toString()+', '+lastPosition.coords.longitude.toString();

        if (mode === "mapcenter"){
            var position = map.getCenter();
            loc = position.lat().toString()+', '+position.lng().toString();
        }
        info();
        $.ajax({ 
            type: 'POST', 
            url: '/updateScan', 
            data: {
                location: loc
            }, 
            dataType: 'json',
            success: function (data) {
                setTimeout(function(){
                    getPokemons();
                    getPokestops();
                }, 10000);
            },
            error: function(e) {
                error('Error while rescaning');
                setTimeout(function(){
                    hide_message();
                }, 3000);
                console.log(e);
            }
        });
    }

    function initMap() {
        update_position();
        setInterval(function(){
            update_position();	
        }, 120000);
    }

    function build_initial_map(location) {
        $('#map_canvas').html('');
        create_map(location);
        if(!userLogged) {
            requestLogin(location);
        } else {
            getPokemons();
        }
        info();
    }

    function update_position(){
        console.log("updating position");
        navigator.geolocation.getCurrentPosition(update_player,
            function(){
                console.log("failed to get gps location....");
            }
        ,{timeout:30000});
    }

    function update_player(location) {
        lastPosition = location;
        var position = new google.maps.LatLng(location.coords.latitude, location.coords.longitude);
        if(map == null){
            build_initial_map(location);
        } else {
            getNewData();
        }
        if(player === null) {
            player = add_player(position);
        } else{
            player.setPosition(position);
        }
    }

    function add_player(position){
        return add_marker(
            {
                name: 'You',
                position: position,
                ico:'/static/poke/trainer.gif'
            }
        );
    }

    function add_marker(data){
        var marker = new google.maps.Marker({
            position: data.position,
            map: map,
            title: data.name,
            icon: {
                url: data.ico
            }
        });
        return marker;
    }

    function create_map(location) {
        var mapOptions = {
            mapTypeId: 'roadmap',
            center:{
                lat:location.coords.latitude, 
                lng:location.coords.longitude
            },
            zoom: 17
        };
        // Display a map on the page
        map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
    }

    function info(msg){
        show_message(msg);
    }

    function error(msg){
        show_message(msg, "red");
    }

    function success(msg){
        show_message(msg, "green")
    }

    function show_message(msg, addClass){
        $("#loader").removeClass("green").removeClass("red").addClass("show");
        if(addClass !== undefined){
            $("#loader").addClass(addClass);
        }
        if(msg === undefined){
            msg = 'Searching for Pokémon...';
        }
        $("#loader").html(msg);
    }

    function hide_message(){
        $("#loader").removeClass("show").removeClass("green").removeClass("red");
    }

    function get_time_left(d){
        var timeLeft = (d.getTime() - (new Date()).getTime()) / 1000;
        return seconds_to_hsm(timeLeft);
    }

    function seconds_to_hsm(d) {
        d = Number(d);
        var h = Math.floor(d / 3600);
        var m = Math.floor(d % 3600 / 60);
        var s = Math.floor(d % 3600 % 60);
        return ((h > 0 ? h + ":" + (m < 10 ? "0" : "") : "") + m + ":" + (s < 10 ? "0" : "") + s); 
    }
</script>